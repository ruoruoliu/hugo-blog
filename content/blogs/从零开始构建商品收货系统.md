---
title: 从零开始构建商品收货系统
date: 2026-01-05
tags:
  - 技术笔记
draft: false
---

> [!NOTE] 背景
> - 需求：老家亲戚是做衣服加工的，分为横机和套口两个种类，现在要做一个功能，来汇总和清晰的展示一些统计数据
> - 现状：目前使用excel来完成：图1包含了横机的单位重量（重量/件）、施工单位和套口的施工单位的基础信息；图2包含了横机按时间、施工单位、件数、重量（件数 * 重量/件）的明细；图3包含了套口按时间、施工单位、件数（包含发出和收回）的明细
![image.png|200](https://images.ruoruoliu.com/2026/01/fbe7544d4533b4bb627a9a95b106a95d.png)![image.png|200](https://images.ruoruoliu.com/2026/01/97120c9fde45e0db35713dbe92939d45.png)![image.png|200](https://images.ruoruoliu.com/2026/01/126c8739f57f265710c6282d078f7bf0.png)
> - 痛点：亲戚目前每天手动填写当天的新增条目（哪个单位给了多少，什么款式，如果是套口还包含收回多少），然后需要下拉excel单元格显示结果（excel的列目前用公式指定怎么计算结果）。现在希望可以只用手动添加条目，不用excel下拉的方式，且统一品类在同一页面方便截图
> - 想法：做一个网页，加一个后台数据库，直接访问网页操作，但是考虑数据隐私和亲戚电脑没有联网的情况，设计为本地保存数据

# 整体思路
--- 
基于上述要求，gemini的思路：
![image.png|500](https://images.ruoruoliu.com/2026/01/545c6595825ace6c623a6c702a3e514b.png)
方案二细节：[从零开始构建商品收货系统-方案细节](../Answers/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E6%9E%84%E5%BB%BA%E5%95%86%E5%93%81%E6%94%B6%E8%B4%A7%E7%B3%BB%E7%BB%9F-%E6%96%B9%E6%A1%88%E7%BB%86%E8%8A%82.md)

# 具体实现
--- 
## 代码链接
[product-record-manager](https://github.com/ruoruoliu/product-record-manager)

## 网页布局

![image.png](https://images.ruoruoliu.com/2026/01/8d70f1f285765f19cc0f89c50637c8ce.png)
- 侧边栏分为横机、套口两个子页面，子页面逻辑几乎一致（套口不包含重量）
- 子页面（以横机为例）：
	- 顶部两个卡片添加款式和加工单位，使用频率低所以默认收缩，可点击展开，展开固定三行，超过部分用scroll方式查看
	- 新增记录部分选择款式、加工单位和件数，通过关联款式基础表的单位重量计算总重量，插入明细表
	- 明细展示部分支持按日期、款式和加工单位筛选，结果中默认展示明细，明细支持修改和删除；点击聚合按钮按日期、款式和加工单位聚合件数和重量，聚合后不支持修改和删除

## 技术细节

- 框架: Flask + SQLAlchemy + Bootstrap 5
- 数据库: SQLite
- 设计模式:
    - Models (模型层): 定义了数据结构（款式，加工单位，横机记录，套口记录)
		![image.png|400](https://images.ruoruoliu.com/2026/01/fd29745418c6b1270d902905a82a3247.png)
    - Templates (视图层): 使用Jinja2模板引擎，index.html作为基布局，hengji.html和taokou.html作为具体页面
    - Routes (控制层): app.py中定义的函数处理URL请求、数据库操作和页面跳转

### PRG 模式 (Post/Redirect/Get)

通过PRG模式，实现用户刷新页面的时候，筛选条件清空，且不弹出提示表单内容重置的警告

后端接收 POST 请求，不直接查询，而是把筛选条件存入用户的session(类似浏览器的 Cookie 缓存)，然后redirect重定向回首页 (GET)
```
@app.route('/', methods=['GET', 'POST'])
def hengji_index():
    if request.method == 'POST':
        # Store filters in session and Redirect to GET
        session['date_range'] = request.form.get('date_range', '')
        session['unit_filter'] = request.form.getlist('unit_filter')
        session['style_filter'] = request.form.getlist('style_filter')

        return redirect(url_for('hengji_index'))
    
    # GET request: Consume session filters (Flash pattern)
    # Pop them so they don't persist on next refresh
    date_range = session.pop('date_range', '')
    unit_filters = session.pop('unit_filter', [])
    style_filters = session.pop('style_filter', [])
    show_aggregate = session.pop('show_aggregate', False)
    
    # 实际处理逻辑
```


### Flash消息机制（Flask Flash）

flash用于在请求之间传递临时的“一次性”消息（比如“添加成功”、“删除失败”）

后端，消息被加密存储在 Session 中
```
flash('添加成功', 'success') # 参数1: 消息内容, 参数2: 类别(用于前端样式)
return redirect(url_for('hengji_index'))
```

前端，使用了Bootstrap Toast组件来美观地显示这些消息
```
<div class="toast-container ...">
    {% with messages = get_flashed_messages(with_categories=true) %}
         <!-- 遍历并渲染所有消息 -->
    {% endwith %}
</div>
```

### Flatpickr 日期选择器

一个轻量级、功能强大的日期选择 JS 库，比原生的\<input type="date"\>更漂亮且支持范围选择

初始化
```
flatpickr("#dateRange", {
    mode: "range",      // 开启范围选择模式
    dateFormat: "Y-m-d", // 提交给后台的格式
    altInput: true,     // 启用以更友好的格式显示给用户
    altFormat: "Y年m月d日", // 用户看到的格式
    locale: "zh",       // 汉化
    onClose: function(...) {
        // 当用户关闭选择器（选完日期）时，自动提交筛选表单
        document.getElementById('filterForm').submit();
    }
});
```

每次#dataRange修改触发表单提交和页面刷新
```
function setQuickDate(daysAgo) {
	const end = new Date();
	const start = new Date();
	start.setDate(start.getDate() - daysAgo);
	
	const el = document.querySelector("#dateRange");
	if (el && el._flatpickr) {
		el._flatpickr.setDate([start, end], true);
		document.getElementById('filterForm').submit();
	}
}
```

### Modal（模态框/弹窗）

在 Bootstrap 中，Modal是一种非常流行的 UI 组件，它会在页面的顶层创建一个覆盖层，弹出一个对话框。模态框通常被用来执行“添加新记录”、“编辑记录”或“确认删除”等操作，这样用户就不必离开当前页面

![image.png|400](https://images.ruoruoliu.com/2026/01/16252bcc2958a811ec1da7cdab6344ed.png)

在 Bootstrap 的模态框（Modal）结构中：
- .modal（遮罩/容器层）：负责全屏覆盖，包括那个半透明的黑色背景（backdrop）。它控制整个弹窗的显示与隐藏，并且负责监听点击背景关闭弹窗的行为
- .modal-dialog（定位/尺寸层）：负责弹窗在屏幕中的位置（居中还是顶部）以及弹窗的宽度
- .modal-content（内容/皮肤层）：负责弹窗的视觉样式，通常里面会再细分为modal-header、modal-body和modal-footer
```
<!-- Add Unit Modal -->
<div class="modal fade" id="addUnitModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
	        ...
        </div>
    </div>
</div>
```

### 模板继承 (Jinja2 Template Inheritance)

index.html中，利用Jinja2 模板引擎的占位符（坑位）：{% block content %}{% endblock %}
```
<div class="d-flex w-100 overflow-hidden">
    
    # 侧边栏内容
    ...
    
    <div class="col-md-10 content flex-grow-1" style="overflow-x: hidden;">
        {% block content %}{% endblock %}
    </div>
</div>
```

hengji.html中开头写
```
{% extends "index.html" %}
```
然后后面写
```
{% block content %} ...具体内容... {% endblock %}
```
模板引擎在渲染时，就会自动把content的部分填充到index的坑位里面

## 运行细节

- 打包为exe（build_portable_mac.sh）：
	- 下载python的window版本以及依赖的whl
	- 打包并编写.bat文件，在无联网环境下双击直接打开
- 启动逻辑：
	- 启动 → 检查端口是否被占用
       ├─ 已占用 → 打开浏览器 → 退出
       └─ 未占用 → 启动服务器 + 心跳监控
	- app.py中加入心跳检测，判断网页是否alive，如果用户关闭网页，则后台自动关闭，并关闭windows的cmd窗口
		![image.png|500](https://images.ruoruoliu.com/2026/01/a39208c44e4e6f28bc3d37b7117b9e87.png)
	- index.html中加入每两秒发送心跳的逻辑
		![image.png|500](https://images.ruoruoliu.com/2026/01/5cc9764b698ac2abf18698312ade8f41.png)

- 每次用户点击.bat，都会首先检测下5000是否在使用（之前打开过），如果有则打开浏览器并直接关闭新后台，防止多开	
	![image.png|500](https://images.ruoruoliu.com/2026/01/ed66b9a681d5b9858d2d30979ef7f8ff.png)
